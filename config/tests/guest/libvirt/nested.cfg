include tests-shared.cfg
username = root
password = 123456
main_vm = vm1
vms = vm1
nettype = bridge
netdst=virbr0
display = nographic
take_regular_screendumps = no
keep_screendumps_on_error = no
keep_screendumps = no
store_vm_register = no
restore_image_after_testing=no
vga=none
virt_install_binary = /usr/bin/virt-install
hvm_or_pv = hvm
machine_type = pseries
only bridge
no xen, lxc, esx, ovmf
#Filterout unwanted disk types
no qed,qcow2v3,raw_dd,vmdk, usb2
only no_virtio_rng
only smp2
only no_9p_export
only no_pci_assignable
only (image_backend=filesystem)
create_vm_libvirt=yes
kill_vm=yes
kill_vm_libvirt=yes
env_cleanup=yes
mem=8192
smp=8
threads=1
cores=8
sockets=1
vcpu_sockets=1
vcpu_cores=8
vcpu_threads=1
setvcpus_max = 8
vcpu_maxcpus = 8
qemu_binary=/usr/local/lib/python3.9/site-packages/virttest/bin/install_root/bin/qemu-system-ppc64 
emulator_path=/usr/local/lib/python3.9/site-packages/virttest/bin/install_root/bin/qemu-system-ppc64
kernel=/home/epcci/linux/vmlinux
initrd=''
use_serial_login=yes
test_timeout = 72000

variants:
    - vmkernel:
        only virtio_net
        only qcow2
        only smallpages
        only virtio_scsi
        pre_command = "rm -rf /home/epcci/linux;git clone --depth 1 https://github.com/torvalds/linux /home/epcci/linux/ && cd /home/epcci/linux/ && git log -1 && make ppc64le_guest_defconfig && make -j 100 -s"
        kernel_args='root=/dev/sda2 rw console=tty0 console=ttyS0,115200 init=/sbin/init initcall_debug selinux=0'
        only guest_test.isa_serial_operations
        
    - vmstart:
        only boot
        no virsh.boot
        only virtio_net
        only qcow2
        variants:
            - @:
            - with_numa:
                only with_smt1
                numa=yes
                smp=8
                threads=1
                cores=8
                sockets=1
                setvcpus_max = 8
                vcpu_maxcpus = 8
                vcpu_cores = 8
                vcpu_threads = 1
                guest_numa_nodes="node0 node1 node2 node3"
                variants:
                    - symmetric_nodes:
                        numa_mem_node0="2097152"
                        numa_cpus_node0="0-1"
                        numa_nodeid_node0="0"
                        numa_mem_node1="2097152"
                        numa_cpus_node1="2-3"
                        numa_nodeid_node1="1"
                        numa_mem_node2="2097152"
                        numa_cpus_node2="4-5"
                        numa_nodeid_node2="2"
                        numa_mem_node3="2097152"
                        numa_cpus_node3="6-7"
                        numa_nodeid_node3="3"
                    - asymmetric_nodes:
                        numa_mem_node0="1048576"
                        numa_cpus_node0="1,3,7"
                        numa_nodeid_node0="0"
                        numa_mem_node1="2097152"
                        numa_cpus_node1="0,4-5"
                        numa_nodeid_node1="1"
                        numa_mem_node2="2097152"
                        numa_cpus_node2="2"
                        numa_nodeid_node2="2"
                        numa_mem_node3="3145728"
                        numa_cpus_node3="6"
                        numa_nodeid_node3="3"
        variants:
            - @:
            - with_smt1:
                smp=8
                threads=1
                cores=8
                sockets=1
                setvcpus_max=8
                vcpu_maxcpus=8
                vcpu_cores=8
                vcpu_threads=1
                vcpu_sockets=1
            - with_smt2:
                smp=8
                threads=2
                cores=4
                sockets=1
                setvcpus_max=8
                vcpu_maxcpus=8
                vcpu_cores=4
                vcpu_threads=2
                vcpu_sockets=1
            - with_smt4:
                smp=8
                threads=4
                cores=2
                sockets=1
                setvcpus_max=8
                vcpu_maxcpus=8
                vcpu_cores=2
                vcpu_threads=4
                vcpu_sockets=1
            - with_smt8:
                smp=8
                threads=4
                cores=2
                sockets=1
                setvcpus_max=8
                vcpu_maxcpus=8
                vcpu_cores=2
                vcpu_threads=4
                vcpu_sockets=1
            - with_lowmem:
                no with_numa
                mem=2048
            - with_singlecpu:
                only with_smt1
                smp=1
                threads=1
                cores=1
                sockets=1
                setvcpus_max=1
                vcpu_maxcpus=1
                vcpu_cores=1
                vcpu_threads=1
                vcpu_sockets=1
        variants:
            - @:
            - with_intc:
                only with_smt4
                variants:
                    - xics:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=xics"
                    - xive:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=xive"
                    - dual:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=dual"
                    - xics_kernel_irqchip_off:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=xics,kernel-irqchip=off"
                    - xive_kernel_irqchip_off:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=xive,kernel-irqchip=off"
                    - dual_kernel_irqchip_off:
                        virtinstall_qemu_cmdline_vm1=" -M pseries,ic-mode=dual,kernel-irqchip=off"
            - with_vsmt:
                mem = 20480
                no with_intc,mem_merge,with_numa
                only with_smt1
                vms = "vm1"
                cores_vm1=1
                threads_vm1=8
                sockets=1
                vcpu_cores_vm1=1
                vcpu_threads_vm1=8
                vcpu_sockets_vm1=1
                virtinstall_qemu_cmdline_vm1=" -M pseries,vsmt=8"
            - with_nested_cap:
                no with_vsmt,with_intc,mem_merge
                only with_smt4,with_smt8
                virtinstall_qemu_cmdline_vm1=" -M pseries,cap-nested-hv=True"
        variants:
            - with_virtio_scsi:
                kernel_args='root=/dev/sda2 rw console=tty0 console=ttyS0,115200 init=/sbin/init initcall_debug selinux=0'
                no with_virtio_blk
                only virtio_scsi
            - with_virtio_blk:
                kernel_args='root=/dev/vda2 rw console=tty0 console=ttyS0,115200 init=/sbin/init initcall_debug selinux=0'
                no with_virtio_scsi
                only virtio_blk

    - vm:
        kernel_args='root=/dev/sda2 rw console=tty0 console=ttyS0,115200 init=/sbin/init initcall_debug selinux=0'
        only virtio_scsi
        only virtio_net
        only qcow2
        variants:
            - guesttests:
                variants:
                    - memory:
                        only avocado_guest.memhotplug,avocado_guest.eatmemory,avocado_guest.memintegrity
                    - generic:
                        only smallpages
                        only avocado_guest.ltp,avocado_guest.kselftest
                    - cpu:
                        only smallpages
                        vcpu_cores = 4
                        vcpu_threads = 8
                        vcpu_sockets =  1
                        vcpu_maxcpus = 32
                        only avocado_guest.ebizzy,avocado_guest.ppc64_cpu_test
                    - io:
                        vcpu_cores = 16
                        vcpu_threads = 2
                        vcpu_sockets =  1
                        vcpu_maxcpus = 32
                        only avocado_guest.fiotest

            - guestdump:
                only virsh.dump.positive_test.non_acl.live_dump
            - diskhotplug:
                at_dt_disk_device_target = sdb
                only virsh.attach_detach_disk_matrix..at_option_live
                no dt_option_live_config,dt_option_config,dt_option_default,dt_option_live_config,at_okay_dt_error,at_error_dt_error,pre_vm_state_shutoff,pre_vm_state_paused,pre_vm_state_transient,dt_option_current
            - memoryhotplug:
                # FIXME
                only libvirt_mem.positive_test.memory.hot.unplug.max_slots.with_rand_reboot
            - vcpuhotplug:
                start_vm = yes
                test_itr = 2
                mem = 81920
                vcpu_max_timeout = 480
                vcpu_sockets =  1
                vcpu_maxcpus = 64
                topology_correction = "no"
                variants:
                    - 1thread:
                        no hugepages
                        vcpu_cores = 64
                        smp = 1
                        vcpu_threads = 1
                        vcpu_current_num = 1
                        vcpu_plug_num = 64
                        vcpu_unplug_num = 1
                        vcpu_max_num = 64
                        only libvirt_vcpu_plug_unplug..with_maxvcpu
                    - 2threads:
                        no hugepages
                        smp = 2
                        vcpu_cores = 32
                        vcpu_threads = 2
                        vcpu_current_num = 2
                        vcpu_plug_num = 64
                        vcpu_unplug_num = 2
                        vcpu_max_num = 64
                        only libvirt_vcpu_plug_unplug..with_maxvcpu
                    - 4threads:
                        smp = 4
                        vcpu_cores = 16
                        vcpu_threads = 4
                        vcpu_current_num = 4
                        vcpu_plug_num = 64
                        vcpu_unplug_num = 4
                        vcpu_max_num = 64
                        only libvirt_vcpu_plug_unplug..with_maxvcpu
                    - 8threads:
                        no hugepages
                        smp = 8
                        vcpu_cores = 8
                        vcpu_threads = 8
                        vcpu_current_num = 8
                        vcpu_plug_num = 64
                        vcpu_unplug_num = 8
                        vcpu_max_num = 64
                        only libvirt_vcpu_plug_unplug..with_maxvcpu
